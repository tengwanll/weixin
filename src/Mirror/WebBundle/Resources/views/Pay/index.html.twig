{% extends 'MirrorWebBundle:Base:base.html.twig' %}

{% block script %}
<script type="text/javascript">
	var orderId='{{ orderId }}';
	var openId='{{ openId }}';
	var JS_PARAM={};
	checkWeiXinId(openId);
	ajaxAction("get",'/api/order/'+orderId,'',false,function(data,textStatus){
		//获取订单信息填充进页面
	},function(errno,errmsg){

	});
	
	$('.detail-service').click(function () {
		var info={};
		info.orderId=orderId;
		ajaxAction("post",'/api/order/pay',info,false,function(data,textStatus){
			JS_PARAM = data.jsApiParameters;
			JS_PARAM = $.evalJSON(JS_PARAM);
			callPay(orderId);
		},function(errno,errmsg){

		});

	});
	function jsApiCall($orderId)
	{
		WeixinJSBridge.invoke(
			'getBrandWCPayRequest',
			JS_PARAM,
			function(res){
				 if(res.err_msg == "get_brand_wcpay_request:ok" ) {
					location.href= wxPath('/web/user/login');
				 }
				 if(res.err_msg == "get_brand_wcpay_request:cancel" || res.err_msg == "get_brand_wcpay_request:fail"){
					location.href= wxPath('/web/pay/'+$orderId);
				 }
			}
		);
	}

	function callPay($orderId)
	{
		var target=$('.detail-service');
		changeBind(target,true);
		if (typeof WeixinJSBridge == "undefined"){
			if( document.addEventListener ){
				document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
			}else if (document.attachEvent){
				document.attachEvent('WeixinJSBridgeReady', jsApiCall);
				document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
			}
			changeBind(target,false);
		}else{
			jsApiCall($orderId);
			changeBind(target,false);
		}
	}
</script>
{% endblock %}

{% block body %}
	<div class="detail-top">
		订单号:
	</div>
	<table class="detail-table">
		<tr>
			<td>下单时间:</td><td></td>
		</tr>
		<tr>
			<td>订单金额:</td><td>元</td>
		</tr>
		<tr>
			<td>优惠金额:</td><td>元</td>
		</tr>
		<tr>
			<td>收货人姓名:</td><td></td>
		</tr>
		<tr>
			<td>收货人电话:</td><td></td>
		</tr>
		<tr>
			<td>收货地址:</td><td></td>
		</tr>
		<tr>
			<td colspan="2"><button class="detail-service">立即支付</button></td>
		</tr>
	</table>
{% endblock %}